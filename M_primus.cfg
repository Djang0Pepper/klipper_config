#0901
#les valeurs fixe sont dans M_defines.cfg
#CLI : ender_prime_line HAUTEUR=2 DIRECTION=X- LONGEUR=5 SEGMENTATION=11 EXTRUDAGE=2 ECART=5

#####################################################################

[gcode_macro ENDER_PRIME_LINE]
description: Purge nozzle to left

  # ##### FROM defines.cfg in description section #####
  # variable_prime_start_xy: [0,0]        ; xy start coordinates of prime line
  # variable_prime_dir: 'X+'                  ; direction of prime line (X+, X-, Y+, Y-)
  # variable_prime_z: 0                   ; z hight for prime line
  # variable_prime_dist: 0                ; distance between line, move will allways positive
  # variable_prime_lenght: 0              ; length of prime line
  # variable_prime_seg: 0                 ; segments in that the prime line is splitted
  # variable_prime_extrude_per_seg: 0     ; amount of filament extruded per segment

gcode:

  # ##### FROM M_defines.cfg in gcode section  #####
  # {% set user_prime_start_xy = [75.0,5.0] %}   ; x & y start coordinates of prime line
  # {% set user_prime_dir = 'X+' %}              ; direction of prime line (X+, X-, Y+, Y-)
  # {% set user_prime_z = 0.28 %}                ; z hight for prime line
  # {% set user_prime_dist = 0.4 %}              ; distance between line, move will allways positive
  # {% set user_prime_lenght = 150 %}            ; length of prime line
  # {% set user_prime_seg = 11 %}                ; segments in that the prime line is splitted
  # {% set user_prime_extrude_per_seg = 2 %}     ; amount of filament extruded per segment

  {action_respond_info("running : ENDER prime line")}
  ##############################
  ##### get user defines #####
  ##############################

  {% set start_xy = printer['gcode_macro _USER_VARIABLE'].prime_start_xy %}
  {% set dir = printer['gcode_macro _USER_VARIABLE'].prime_dir|string %}
  {% set lenght = printer['gcode_macro _USER_VARIABLE'].prime_lenght|float %}
  {% set seg = printer['gcode_macro _USER_VARIABLE'].prime_seg|int %}
  {% set extrude_per_seg = printer['gcode_macro _USER_VARIABLE'].prime_extrude_per_seg|float %}
  {% set axe_z = printer['gcode_macro _USER_VARIABLE'].prime_z|float %}
  {% set move_between_lines = printer['gcode_macro _USER_VARIABLE'].prime_dist|float %}
  {% set z_hop = printer['gcode_macro _USER_VARIABLE'].z_hop|float %}

  ##### get params or set default #####
  {% set  calc_hei = params.HAUTEUR|default('axe_z')|float %} #a VOIR par rapport zaux autres choix du menu

  {% set  calc_dir = params.DIRECTION|default(dir)|string %}
  {% set  calc_len = params.LONGEUR|default(lenght)|float %}
  {% set  calc_seg = params.SEGMENTATION|default(seg)|int %}
  {% set  calc_ext = params.EXTRUDAGE|default(extrude_per_seg)|float %}
  {% set  calc_mov = params.ECART|default(move_between_lines)|float %}


  ##### get toolhead position #####
  {% set act_z = printer.toolhead.position.z|float %}

  ##### calculate prime line moves #####
  {% set seg_delta = calc_len / calc_seg %}
  {% if calc_dir == 'X+' %}
    {% set first_line = 'X%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set second_line = 'X-%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set move_to_side = 'Y%s' % (calc_mov) %}

    # {% set first_line = 'X%s F1500' % (seg_delta) %}
    # {% set second_line = 'X-%s F1500' % (seg_delta) %}
    # {% set move_to_side = 'Y%s' % (calc_mov) %}

   {% elif calc_dir == 'X-' %}
    {% set first_line = 'X-%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set second_line = 'X%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set move_to_side = 'Y%s' % (calc_mov) %}

    # {% set first_line = 'X-%s F1500' % (seg_delta) %}
    # {% set second_line = 'X%s F1500' % (seg_delta) %}
    # {% set move_to_side = 'Y%s' % (calc_mov) %}

  {% elif calc_dir == 'Y+' %}
    {% set first_line = 'Y%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set second_line = 'Y-%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set move_to_side = 'X%s' % (calc_mov) %}

    # {% set first_line = 'Y%s F1500' % (seg_delta) %}
    # {% set second_line = 'Y-%s F1500' % (seg_delta) %}
    # {% set move_to_side = 'X%s' % (calc_mov) %}

  {% elif calc_dir == 'Y-' %}
    {% set first_line = 'Y-%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set second_line = 'Y%s E%s F1500' % (seg_delta, calc_ext) %}
    {% set move_to_side = 'X%s' % (calc_mov) %}

    # {% set first_line = 'Y-%s F1500' % (seg_delta) %}
    # {% set second_line = 'Y%s F1500' % (seg_delta) %}
    # {% set move_to_side = 'X%s' % (calc_mov) %}

  {% else %}
    {action_raise_error("_USER_VARIABLE.prime_dir is not spezified as X+, X-, Y+ or Y-")}
  {% endif %}
  ##############################
  ##### end of definitions #####
  ##############################


  #-fred _PRINT_AR T="Prime Line" SHOW_LCD=true
  {action_respond_info("homing ")}
  _CG28                                   ; home if not already homed
  G92 E0                                  ; reset Extruder
  G90                                     ; absolute positioning
  {% if act_z < z_hop %}
    G1 Z{z_hop} F900                      ; move head up
  {% endif %}
  G1 X{start_xy[0]} Y{start_xy[1]} F5000 ; move to start position
  G1 Z{ calc_hei} F900                 ; move Z Axis down
  G91                                     ; relative positioning
  {% for segment in range(calc_seg) %}         ; draw the first line
    G1 {first_line}
  {% endfor %}
  G1 {move_to_side}                       ; move to side
  {% for segment in range(calc_seg) %}         ; draw the second line
    G1 {second_line}
  {% endfor %}
  G1 Z{z_hop} F1500                       ; move Z Axis up
  G92 E0                                  ; reset Extruder
  #UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=1
  {action_respond_info("prime line in progress ")}








# # macro pour activer la prime line si T° ok
# # attention usine a gaz a voir avec macro check

[gcode_macro CHECK_WHAT]
description: Unload filament and disable runout while running
gcode:
  {action_respond_info("running : filament unload")}

  ##### get user defines #####
  {% set add_temp = printer['gcode_macro _USER_VARIABLE'].extruder_min_add|int %}
  {% set unload = printer['gcode_macro _USER_VARIABLE'].unload_distance %}
  {% set purge_pos = printer['gcode_macro _USER_VARIABLE'].purge_array %}
  {% set z_hop = printer['gcode_macro _USER_VARIABLE'].z_hop %}

  ##### get toolhead position #####
  {% set act_z = printer.toolhead.position.z|float %}

  ##### get hardware enables #####
  #{% set ena_neo = printer['gcode_macro _USER_VARIABLE'].neo_display|lower %}
  {% set ena_runout = printer['gcode_macro _USER_VARIABLE'].runout|lower %}

  ##### store extruder temps #####
  {% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int + add_temp %}
  {% set extruder_target = printer.extruder.target %}
  {% set loadTemp = params.TEMP|default(0) %}
  {% if loadTemp == 0 %}
    {% set loadTemp = extruder_target%}
  {% endif %}

  ##### end of definitions #####
  ## Home if not homed already.
  _CG28
  G90                            ; absolute positioning
  {% if act_z < z_hop %}
    G1 Z{z_hop} F900            ; move head up
  {% endif %}
  G1 X{purge_pos[0]} Y{purge_pos[1]} F9000 ; move to purge bucket location

  {% if printer.idle_timeout.state != "Printing" or printer.pause_resume.is_paused|lower == "true" %}
    SAVE_GCODE_STATE NAME=STATE_UNLOAD_FILAMENT
    {% if ena_runout == 'motion' %}
      #-fred _PRINT_AR T="RUNOUT Motion Sensor Enable: false"
      {action_respond_info("RUNOUT Motion Sensor Enable: false")}
      SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
    {% endif %}

    {% if ena_runout == 'switch' %}
      #-fred _PRINT_AR T="RUNOUT Switch Sensor Enable: false"
      {action_respond_info("RUNOUT Switch Sensor Enable: false")}
      SET_FILAMENT_SENSOR SENSOR=runout ENABLE=0
    {% endif %}

    #{% if ena_neo == 'true' %} _LCD_KNOB COLOR=BLUE {% endif %}

    {% set temp_changed = false %}
    {% if printer.extruder.can_extrude|lower == 'false' %}
      {action_respond_info("Extruder Temp too low. wait heating to %2dC" % minTemp)}
      {% set temp_changed = true %}
      M109 S{minTemp} ; heat extruder and wait
      {action_respond_info("heating in  progress")}
    {% endif %}

    {% if loadTemp != extruder_target %}
      {% set temp_changed = true %}
      {action_respond_info("check heat")}
      M109 S{loadTemp}
      {action_respond_info("check heat ended")}
    {% endif %}

    # Ball up the filament tip and retract out past the extruder gears
    #{% if ena_neo == 'true' %} _LCD_KNOB COLOR=RESTORE {% endif %}
    _FILAMENT_BALL WAIT=3
    M83 ; Relative extrusion
    G1 E-{unload} F3000
    {action_respond_info("unloading  : %i mm" %(unload))}
    M400 #wait to finishing all move
    SAVE_VARIABLE VARIABLE=filament_loaded VALUE='"false"'
    # restore old extruder temperature

    {% if temp_changed %}
      {action_respond_info("temp changed")}
      M109 S{extruder_target}
    {% endif %}



[gcode_macro CHECK_EXT_TEMP]
description: CHECK_EXT_TEMP EXT_T=xxx
gcode:
    {% set EXT_TEMP = params.EXT_T|default(180)|int %}
    {% if printer.extruder.target != 0 %} # if there is a setpoint for extruder
        {% if printer.extruder.temperature < printer.extruder.target %} # if not reached, heat
            #M118 Heating from {printer.extruder.temperature} to {printer.extruder.target}.
            M109 S{printer.extruder.target}
            #M118 "EXT TEMP Reached"
        {% endif %}
    {% else %} # if no setpoint for extruder
        {% if printer.extruder.target < EXT_TEMP %}  # heat to EXT_T.
            #M118 No setpoint, heating to {EXT_TEMP}.
            M109 S{EXT_TEMP}
            #M118 "EXT TEMP Reached"
        {% endif %}
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro CHECK_BED_TEMP]
description: CHECK_BED_TEMP BED_T=xxx
gcode:
    {% set BED_TEMP = params.BED_T|default(52)|int %}
    {% if printer.heater_bed.target != 0 %} # if there is a setpoint for heater_bed
        {% if printer.heater_bed.temperature < printer.heater_bed.target %} # if not reached, heat
            #M118 Heating from {printer.heater_bed.temperature} to {printer.heater_bed.target}.
            M190 S{printer.heater_bed.target}
            #M118 "BED TEMP Reached"
        {% endif %}
    {% else %} # if no setpoint for extruder
        {% if printer.heater_bed.target < BED_TEMP %}  # heat to BED_T.
            #M118 No setpoint, heating to {BED_TEMP}.
            M190 S{BED_TEMP}
            #M118 "BED TEMP Reached"
        {% endif %}
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££