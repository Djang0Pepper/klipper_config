[bltouch]
sensor_pin: ^PB1
control_pin: PB0
x_offset: -35
y_offset: -12
#z_offset: 0.375 0217A
#z_offset: check bed mesh sucker
speed: 2.0
sample_retract_dist: 3.5
samples: 5

[safe_z_home]
#home_xy_position: 117.5,117.5 # Change coordinates to the center of your print bed
#home_xy_position: 110,110 # ~fred for nozzle
home_xy_position: 145,122 # ~fred for probe 110+35 & 110+12
z_hop: 3.5                  # 3mm fred
z_hop_speed: 5

[bed_mesh]
speed: 240
horizontal_move_z: 5
mesh_min: 28, 28        #~fred 063-35 & 040 - 12
mesh_max: 200, 200      #~fred 235-35 & 212 - 12
probe_count: 3,3    #~fred
algorithm: bicubic
fade_start: 1
fade_end: 10
fade_target: 0

[screws_tilt_adjust]
screw1: 63,212  #~fred
screw1_name: rear left screw
screw2: 63,40  #~fred
screw2_name: front left screw
screw3: 235,40  #~fred
screw3_name: front right screw
screw4: 235,212 #~fred
screw4_name: rear right screw
horizontal_move_z: 5
speed: 50
screw_thread: CW-M4

[respond]
default_type: command

[pause_resume] recover_velocity: 50

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16          #(200 steps per revolution, 1.8°), run with 1/16 microstepping. So one full rotation is 200 * 16 = 3200 steps
rotation_distance: 40   #The Ender 3 has 20 tooth pulleys so one full rotation of the stepper is 20 * 2 = 40mm
endstop_pin: ^PA5       #3200 steps / 40mm = 80 steps/mm for X and Y
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
#endstop_pin: ^PA7
#position_endstop: 0.0
position_max: 250
position_min: -3
endstop_pin: probe:z_virtual_endstop

[extruder]
max_extrude_only_distance: 100.0
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16            #200 * 16 = 3200 steps
rotation_distance: 31.774 #30.406
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
control: pid
# tuned for stock hardware with 200 degree Celsius target
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
# tuned for stock hardware with 50 degree Celsius target
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[virtual_sdcard]
path: ~/gcode_files

[display_status]

###############################
# timelaps
###############################

#[gcode_macro TIMELAPSE_TAKE_FRAME]
#gcode:
# {action_call_remote_method("timelapse_newframe")}

###############################
# Klipper Config Check
###############################

#[gcode_macro DUMP_WARNINGS]
#description: Debug: Print all warning messages from klipper
#gcode:
 # {% set parameters = ["printer.configfile.warnings:"] %}
 # {% for name1 in printer.configfile.warnings %}
 #     {% set parameters = parameters.append("%s -> %s -> %s\n%s" % (name1.type, name1.section, name1.option, name1.message)) %}
 # {% endfor %}
 # {action_respond_info(parameters|join("\n"))}


#######################################################################

#######################################################################
###################################################### START/END MACROS
#######################################################################

[gcode_macro START_PRINT_SUPERSLICER]
description: a start/end gcode exemple
gcode:
    G90 ; use absolute coordinates
    M83 ; extruder relative mode

    M140 S{first_layer_bed_temperature[initial_extruder]} ;
    M117 -->set final bed temp

    M104 S150 ;
    M117 -->set temporary nozzle temp to prevent oozing during homing

    G4 S10 ;
    M117 -->allow partial nozzle warmup

    G28 ;
    M117 -->home all axis
    ;G29 ; auto bed levelling

    G1 Z25 F240
    G1 X2 Y10 F3000
    M104 S{first_layer_temperature[initial_extruder]+EXT_TEMPerature_offset[initial_extruder]} ;
    M117 -->set final nozzle temp
    M190 S{first_layer_bed_temperature[initial_extruder]} ;
    M117 -->wait for bed temp to stabilize
    M109 S{first_layer_temperature[initial_extruder]+EXT_TEMPerature_offset[initial_extruder]} ;
    M117 -->wait for nozzle temp to stabilize
    G1 Z0.20 F240 ;Z0.28
    G92 E0

    G1 Y200 E10 F1500 ;
    M117 -->prime the nozzle Y
    G1 X2.3 F1500
    G92 E0
    G1 Y10 E10 F1200 ;
    M117 --> prime the nozzle Y home
    G92 E0

    G1 X200 E10 F1500 ;
    M117 --> prime the nozzle X
    G1 Y10.3 F1500
    G92 E0
    G1 X10 E08 F1200 ;
    M117 --> prime the nozzle X home
    G92 E0


#####################################################################################

[gcode_macro END_PRINT_SUPERSLICER]
description: a start/end gcode exemple
gcode:
  {%if max_layer_z < max_print_height%}
    G1 Z{z_offset+min(max_layer_z+2, max_print_height)} F600 ; Move print head up
  {%endif%}

  G1 X5 Y{print_bed_max[1]*0.8} F{travel_speed*60} ; present print

  {%if max_layer_z < max_print_height-10%}
    G1 Z{z_offset+min(max_layer_z+70, max_print_height-10)} F600 ; Move print head further up
  {%endif%}

  {%if max_layer_z < max_print_height*0.6%}
    G1 Z{max_print_height*0.6}} F600 ; Move print head further up
  {%endif%}

  M140 S0 ; turn off heatbed
  M104 S0 ; turn off temperature
  M107 ; turn off fan
  M84 X Y E ; disable motors

#####################################################################################

[gcode_macro START_PRINT]
description: a start/end gcode exemple
gcode:
  M117 "use gcode_macro inside printer.cfg"
  #https://github.com/Desuuuu/klipper-macros/tree/master/macros
  #useless
  #default_parameter_BED_TEMP: 0
  #default_parameter_EXT_TEMP: S{first_layer_temperature[initial_extruder]+EXT_TEMPerature_offset[initial_extruder]} ;
  #M140 S{first_layer_bed_temperature[initial_extruder]} ;
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXT_TEMP = params.EXT_TEMP|default(180)|float %}

  ;Put printing message on LCD screen
  M117 Heating BED...
  M140 S{BED_TEMP} ; set bed temp
  {% if printer.heater_bed.temperature < params.BED_TEMP|float*0.85 %}
    M190 R{params.BED_TEMP|float*0.85} # wait till 0.85 of bed temp is reached, then continue
  {% endif %}

  G28 X Y; Home X Y
  G1 Y10 F3000; this is a good start heating position
  M190 S{BED_TEMP} ;
  M117 wait for bed temp
  G28 Z ; Home Z
  M104 S{EXT_TEMP} ;
  M117 set extruder temp

  ; Auto Leveling
  BED_MESH_PROFILE LOAD=default
  M117 LOAD DEFAULT MESH
  M109 S{EXT_TEMP} ; wait for extruder temp
  M117 wait for extruder temp
  M117 Priming
  ; Start of print
  G21; metric values
  G90 ; absolute positioning
  M82; set extruder to absolute mode

  G1 Z5; Move nozzle above 5 mm of the bed

  ; now print a line of filament to prepare extrusion
  G92 E0 ; reset extruder
  G1 X5 Y15 F5000.0 ; move to start-line position
  G1 X5 Y15 Z2.3 F5000.0
  ;G1 X5 Y15 Z0.3 F5000.0
  G1 Y20 F1000 E0.8
  G92 E0 ; reset extruder
  G1 X5 Y200.0 Z0.3 F1500.0 E15 ; draw 1st line
  G1 X5.4 Y200.0 Z0.3 F5000.0 ; move to side a little
  G1 X5.4 Y20 Z0.3 F1500.0 E30 ; draw 2nd line
  G1 E34 ; Retract extruder
  G92 E0 ; reset extruder
  G1 Z3.0 F3000 ; move z up little to prevent scratching of surface
  G1 X100 Y100 F15000

  ;Tuning params
  ;Put printing message on LCD screen
  M117 Printing...
  M83
  ; Start of actual GCode for the print

#####################################################################################

[gcode_macro END_PRINT]
description: a start/end gcode exemple
#https://github.com/Desuuuu/klipper-macros/tree/master/macros
gcode:
    M140 S0
    M104 S0
    G92 E1
    G1 E-1 F300
    M106 S0
    G28 X0
    G90
    M84
    #SAVE_IF_SET
#####################################################################################

[gcode_macro PRIME_LINE]
description: prime line
gcode:
    M117 "Prime Line"
    G92 E0 ;Reset Extruder
    M117 "Move z axis"
    G1 Z2.0 F3000 ;Move Z Axis up
    M117 "Move to prime position"
    G1 X20 Y30 Z0.28 F5000.0 ;
    M117 "Move to start position"
    G1 X20 Y200.0 Z0.28 F1500.0 E15 ;
    M117 "Draw the first line"
    G1 X22 Y200.0 Z0.28 F5000.0 ;
    M117 "Move to side a little"
    G1 X22 Y50 Z0.28 F1500.0 E30 ;
    M117 "Draw the second line"
    G92 E0 ;
    M117 "Reset Extruder"
    G1 Z2.0 F3000 ;
    M117 "Move Z Axis up"

#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££
#££££££££££££££££££££££££££££££££££££ SYSTEM MACROS £££££££££££££££££££££££££££££££££
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro G29]
gcode:
    M117 "HOME AXIS"
    G28

    M117 "BED HEATING"
    M190 S50
    M117 "BED HEATING REACHED"

    M117 "BED CALIBRATE"
    BED_MESH_CALIBRATE

    M117 "BED SAVED AS DEFAULT"
    SAVE_CONFIG
    G0 X0 Y0 Z10
    M117 MACROG29 ENDED
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro CANCEL_PRINT]
description: Cancel the running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    G1 E-5 F300
    M117 "extract for next print"
    TURN_OFF_HEATERS
    M117 "turn off heater"
    CANCEL_PRINT_BASE
    M117 "up to you"
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
variable_extrude: 1.0 # change this if you need more or less extrusion
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F4100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    
    G1 Z+33
    G1 X{x_park} Y{y_park} F6000
    #G1 Z+33
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %}

#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F4100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  RESUME_BASE {get_params}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro LOW_TEMP_CHECK]
description: a tester pas sursur
gcode:
    {% set EXT_TEMP = params.T|default(180)|int %}
    {% if printer.extruder.target != 0 %} # if there is a setpoint for extruder
        {% if printer.extruder.temperature < printer.extruder.target %} # if not reached, heat
            M118 Heating from {printer.extruder.temperature} to {printer.extruder.target}.
            M109 S{printer.extruder.target|float}
        {% endif %}
    {% else %} # if no setpoint for extruder
        {% if printer.extruder.target < EXT_TEMP %}  # heat to T.
            M118 No setpoint, heating to {EXT_TEMP}.
            M109 S{EXT_TEMP}
        {% endif %}
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro COUNTDOWN]
description: ount down msg=coucou time=50(sec)
gcode:
  {% set MSG = params.MSG|default("Time :: ")|string %}
  {% set TIME = params.TIME|default(10)|float %}
  # countdown
  {% for s in range(TIME|int, 0, -1) %}
      # dwell 1 second
      G4 P1000
      # echo
      M117 {params.MSG} {s}s
  {% endfor %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M117]
rename_existing: M117 { rawparams }
gcode:
  #M117.1 { rawparams }
  #RESPOND PREFIX=“info” MSG="{ params }"
  M118 { rawparams }
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M204]
rename_existing: M204.1
gcode:
  {% set f = params.F|default(0.5)|float %}

  {% if 'S' in params %}
    {% set s = params.S|float %}
    SET_VELOCITY_LIMIT ACCEL={s} ACCEL_TO_DECEL={ s * f }
  {% else %}
    {% if 'P' in params %}
      {% set p = params.P|float %}
      {% if 'T' in params %}
        {% set t = params.T|float %}
        {% if p < t %}
          SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={ p * f }
        {% else %}
          SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={ t * f }
        {% endif %}
      {% else %}
        SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={ p * f }
      {% endif %}
    {% elif 'T' in params %}
      {% set t = params.T|float %}
      SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={ t * f }
    {% endif %}
  {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M205]
gcode:
    {% if 'X' in params %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ X }
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

# Park toolhead
[gcode_macro M125]
description: parking hotend
gcode:
    SAVE_GCODE_STATE NAME=parking
    M117 "Parking toolhead"
    G91         #Use relative position mode
    G1 Z20 F600 # move up 20 mm
    G90         #Use absolute position mode
    G1 X125 Y0 F4000 # move to park position
    RESTORE_GCODE_STATE NAME=parking
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££


#[idle_timeout]
#gcode:
#  {% if printer.pause_resume.is_paused %}
#    M104 S0
#  {% else %}
#   TURN_OFF_HEATERS
#   M84
#  {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££


#[gcode_shell_command hello_world]
#command: echo hello world
#timeout: 2
#verbose: True
#M117 "Executewith:RUN_SHELL_COMMAND_CMD=hello_world";

#[gcode_macro RESTART_ALL]
#gcode:
#   RUN_SHELL_COMMAND CMD=restart_klipper_services
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

#[gcode_shell_command restart_klipper_services]
#command: sudo restart_klipper
#timeout: 2.
#verbose: True
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

#[gcode_macro FIRMWARE_RESTART]
#rename_existing: FIRMWARE_RESTART_OG
#gcode:
#   RESTART_ALL


#------------------------------------------------------------------------------------------
#-------------------------------------- FILAMANET MACRO -----------------------------------
#------------------------------------------------------------------------------------------

[gcode_macro M701]
description: Load filament LowTempCheck
gcode:
  SAVE_GCODE_STATE NAME=loading_filament
  M117 "Loading Filament"
  M83
  G92 E0.0
  LOW_TEMP_CHECK
  G1 E440 F6000   # length of bowden tube till cold-end (~420mm)
  G1 E100 F200    # some extra to prime the nozzle --> slower
  G92 E0.0
  RESTORE_GCODE_STATE NAME=loading_filament
#------------------------------------------------------------------------------------------

[gcode_macro M702]
description: Unload filament LowTempCheck
gcode:
  SAVE_GCODE_STATE NAME=unloading_filament
  M125 # park
  M117 "Unloading Filament"
  LOW_TEMP_CHECK
  G91 # set relative
  G1 E-10 F100
  G92 E0.0
  G1 E-440 F6000 # the E is the length of the bowden tube (440mm) + 10 mm.
  G92 E0.0
  RESTORE_GCODE_STATE NAME=unloading_filament
#------------------------------------------------------------------------------------------

[gcode_macro FILAMENT_RUNOUT]
description:  Out of filament!
gcode:
    M117 Out of filament!
    SAVE_GCODE_STATE NAME=filament_out
    M117 Pausing...
    PAUSE
    G91 # relative
    G1 E-1 F300 # retract 1
    M117 Unloading...
    M702 # unload
    M117 Setting hotend to 0
    M109 S0
    M117 Replace Filament!
    RESTORE_GCODE_STATE NAME=filament_out
#------------------------------------------------------------------------------------------

[gcode_macro M600]
description: Filament change
gcode:
  M117 Filament Change
  M117 Filament Change
  SAVE_GCODE_STATE NAME=filament_change
  PAUSE
  LOW_TEMP_CHECK
  G91 # relative
  G1 E-1 F300 # retract 1
  M125 # park
  M702 # unload

  M117 New filament
  M117 New filament
  COUNTDOWN TIME=25 MSG="Switch"
  M701
  COUNTDOWN TIME=10 MSG="Clean"
  RESUME
  M117 Resuming

  RESTORE_GCODE_STATE NAME=filament_change
  M117 Printing..

#------------------------------------------------------------------------------------------

[gcode_macro FIL_RETRACT]
description: FIL_RETRACT D=40 F=240
gcode:
  {% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int %}
  {% set speed = params.F|default(600)|float %}

  {% if 'D' in params %}
    {% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
      {action_respond_info("This command cannot be used while printing")}
    {% elif printer.extruder.can_extrude|lower == 'false' %}
      {action_respond_info("Extruder Temp too low, heat to %2dC" % minTemp)}
      {% set temp_changed = true %}
      M109 S{minTemp} ; heat extruder and wait
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E-{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% else %}
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E-{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% endif %}
  {% endif %}
#------------------------------------------------------------------------------------------

[gcode_macro FIL_EXTRACT]
description: FIL_EXTRACT D=40 F=240
gcode:
  {% set speed = params.F|default(600)|float %}
  {% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int %}
  #{% set add_temp = printer['gcode_macro _USER_VARIABLE'].extruder_min_add|int %}
  #{% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int + add_temp %}
  {% if 'D' in params %}
    {% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
      {action_respond_info("This command cannot be used while printing")}
    {% elif printer.extruder.can_extrude|lower == 'false' %}
      {action_respond_info("Extruder Temp too low, heat to %2dC" % minTemp)}
      {% set temp_changed = true %}
      M109 S{minTemp} ; heat extruder and wait
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E-{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% else %}
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% endif %}
  {% endif %}
#------------------------------------------------------------------------------------------

[gcode_macro FILAMENT_LOAD]
description: buggé
#variable_parameter_T_BED: 60
#variable_parameter_T_EXTRUDER: 190
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(060)|float %}
  {% if printer.heater_bed.temperature < params.BED_TEMP|float*0.85 %}
    M190 S{params.BED_TEMP|float*0.85} # wait till 0.85 of bed temp is reached, then continue
    {% endif %}
    M83           ; set e to relative positioning
    G92 E0.0
    G1 E100 F1000  ; Initially go fast

    G92 E0.0
    G1 E100 F1000  ; Initially go fast

    G92 E0.0
    G1 E100 F1000  ; Initially go fast

    G92 E0.0
    G1 E100 F1000  ; Initially go fast

    G92 E0.0
    G1 E40 F200  ; then go slow

    G92 E0.0




#------------------------------------------------------------------------------------------

[gcode_macro FILAMENT_UNLOAD]
description: buggé
gcode:
    M83           ; set e to relative positioning
    # wiggle filament out of the nozzle
    G1 E0.5 F1000
    G1 E-0.5 F1000
    G1 E1.0 F1000
    G1 E-1.0 F1000
    G1 E1.5 F1000
    G1 E-1.5 F1000
    G1 E2.0 F1000

    G1 E-440 F3000 ;fully unload
    G92 E0.0

  # M600: Filament Change. This macro will pause the printer, move the
  # tool to the change position, and retract the filament 50mm. Adjust
  # the retraction settings for your own extruder. After filament has
  # been changed, the print can be resumed from its previous position
  # with the "RESUME" gcode.
#------------------------------------------------------------------------------------------

[gcode_macro PULL_COLD]
description: Cancel the print and made a pull cold
gcode:
 M140 S0        ;
 M117 "turn off heatbed"
 M104 S0        ;
 M117 "turn off temperature"
 #M84 X Y  E      ; disable motors
 G0 Y50 X220 Z+25 F6000 ;
 M117 "prepare cooling"
 M106 S255   ;
 M117 "set the fan to full speed"
 M109 R185 ;
 M117 "wait extruder cooling for reaching 180 "
 M106 S0   ;
 M117 "set the fan to disable"
 G0 Y220 X220 F6000 ;

 M107 ;
 M117 "turn off fan"
 M83
 G1 E-5 F300
 M117 "extract for next print"
 TURN_OFF_HEATERS
 M117 "turn off heater"
 M84
 M117 "motors OFF take your piece"
 CANCEL_PRINT_BASE


#------------------------------------------------------------------------------------------

#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#'''''''''''''''''''''''''''''''''''''''''''' BLTOUCH MACRO
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro CENTER_Nozzle]
description: Center Nozzle
gcode:
  G91
  G1 Z+5
  G90
  G0 X110 Y110 F2000
  G91
  G1 Z-5
  G90
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro CENTER_Probe]
description: Center Probe
gcode:
  G91
  G1 Z+5
  G90
  G0 X145 Y122 F2000
  G91
  G1 Z-5
  G90

#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro PROBING]
description: Bltouch PROBE
gcode:
 probe
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro UP]
description: Pin UP
gcode:
 BLTOUCH_DEBUG COMMAND=pin_up
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro DOWN]
description: Pin DOWN
gcode:
 BLTOUCH_DEBUG COMMAND=pin_down
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro TEST]
description: Probe TEST
gcode:
 BLTOUCH_DEBUG COMMAND=self_test
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro STOP-TEST]
description: Probe RESET
gcode:
 BLTOUCH_DEBUG COMMAND=reset
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro Z_RESET_OFFSET]
description: Z Adjust NULL
gcode:
 SET_GCODE_OFFSET Z=0.0 MOVE=1
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro GET_POS]
description: GET_POSITION
gcode:
 GET_POSITION
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\  BED MESH  #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
[gcode_macro A_SCREW_TILT_CALCULATE_HOT_MACRO]
gcode:
  M117 "Homing"
  G28 F5000
  M117 "BED HEATING"
  M190 S50 R55
  M117 "BED HEATING REACHED"
  M117 "TILTING"
  SCREWS_TILT_CALCULATE
  M117 "TILT DONE"
  G1 X0 Y0 Z8 F5000
  M117 "Homing"
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro A_SCREW_TILT_CALCULATE_COLD_MACRO]
gcode:
  M117 "Homing"
  G28 F5000
  M117 "TILTING"
  SCREWS_TILT_CALCULATE
  M117 "TILT DONE"
  G1 X0 Y0 Z8 F5000
  M117 "Homing"
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro B_BED_MESH_CALIBRATE_COLD_MACRO]
gcode:
  M117 "HOME AXIS"
  G28
  M117 "BED_MESH_CALIBRATE"
  BED_MESH_CALIBRATE
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro B_BED_MESH_CALIBRATE_HOT_MACRO]
gcode:
  G29
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro C_PROBE_CALIBRATE_MACRO]
gcode:
  M117 "you can remove PETG residus it's heating"
  M104 S180
  M117 "MAKE SURE BED  SCREW_TILT_CALCULATE_MACRO & BED_MESH_CALIBRATE_COLD_MACRO DONE"
  G28 F6000
  M117 "Grab a piece of paper and slide it between the nozzle and print bed"
  PROBE_CALIBRATE
  M117 "type TESTZ(space)z=-0.1"
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro DE_PROBE_ACCURACY_MACRO]
gcode:
 G28 F5000
 PROBE_ACCURACY
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro E_SAVE_CONFIG_MACRO]
gcode:
 SAVE_CONFIG
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro E_SAVE_MESH_PROFILE_MACRO]
gcode:
 BED_MESH_PROFILE SAVE{S}
 #BED_MESH_PROFILE LOAD=<name> SAVE=<name> REMOVE=<name>
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro LOAD_MESH_DEFAULT_MACRO]
gcode:
 BED_MESH_PROFILE LOAD=default
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro LOADMESH_TONIGHT_MACRO]
gcode:
 BED_MESH_PROFILE LOAD=tonight
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro LOADMESH_TODAY_MACRO]
gcode:
 BED_MESH_PROFILE LOAD=today
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.102500, 0.113500, 0.168000
#*# 	0.031500, 0.085500, 0.072000
#*# 	-0.005500, 0.037000, 0.058000
#*# tension = 0.2
#*# min_x = 28.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 2
#*# min_y = 28.0
#*# x_count = 3
#*# max_y = 200.0
#*# mesh_x_pps = 2
#*# max_x = 200.0
#*#
#*# [bed_mesh tonight]
#*# version = 1
#*# points =
#*# 	-0.026000, -0.050000, -0.068500
#*# 	-0.010000, -0.005000, -0.025500
#*# 	0.021000, -0.003000, -0.023500
#*# tension = 0.2
#*# min_x = 28.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 2
#*# min_y = 28.0
#*# x_count = 3
#*# max_y = 200.0
#*# mesh_x_pps = 2
#*# max_x = 200.0
#*#
#*# [bltouch]
#*# z_offset = 0.451
