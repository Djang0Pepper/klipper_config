#####################################################################
#  File location of stored variables
######################################################################
[save_variables]
filename: /home/pi/klipper_config/.variables.stb
#

#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
#  Idle Timeout
#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
[idle_timeout]
gcode:
  {action_respond_info("running : idle_timeout")}
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      {action_respond_info("POWER OFF : Fan Heaters Motors Timeout")}
      M107
      TURN_OFF_HEATERS
      M84
      POWER_OFF_PRINTER
      {action_respond_info("running idle_timeout cos nothing happened")}
    {% endif %}
  {% endif %}
# 10min  timeout
timeout: 600
#

#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
#CHECK CONFIG
#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
[delayed_gcode _CHECK_CONFIG]
initial_duration: 0.1
gcode:
  {action_respond_info("running check_config")}
  ## exexcute _USER_VARIABLE once at startup to do the needed calcs
  {% if printer['gcode_macro _USER_VARIABLE'] is not defined %}
    { action_respond_info(
      "CONFIG: ERROR\n"
      "_USER_VARIABLE macro missing\n"
      "This holds common variables for your printer and must be defined") }
  {% else %}
    _USER_VARIABLE
    _CHECK_CONSISTENT
  {% endif %}
#

#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
#CHECK CONSISTENT
#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
[gcode_macro _CHECK_CONSISTENT]
description: Helper: Check that some criterias are meet in the printer.cfg
gcode:
  {action_respond_info("running check_consistent")}
  ## check that a MagProbe is defined if z_calibrate is defined
  {% if printer['gcode_macro _USER_VARIABLE'].auto_z_offset|lower == 'z_calib' and
    printer['gcode_macro _USER_VARIABLE'].mag_probe|lower == 'false' %}
    {action_respond_info(
                         "CONFIG: ERROR\n"
                         "[z_calibration] defined but no MagProbe\n")}
  {% endif %}
  ## check if save_variables are defined
  {% if 'save_variables' not in printer %}
    {action_respond_info(
                         "CONFIG: ERROR\n"
                         "[save_variables] missing\n"
                         "This is needed to store variables to a file")}
  {% endif %}
  ## check if virtual_sdcard is defined
  {% if 'virtual_sdcard' not in printer %}
    {action_respond_info(
                         "CONFIG: ERROR\n"
                         "[virtual_sdcard] missing\n"
                         "The printer.cfg is designed to be used with Mainsail, therefore this definition is essential")}
  {% endif %}
#

#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
# CANCEL PRINT
#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
[gcode_macro CANCEL_PRINT]
description: Cancel the running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  {action_respond_info("running : CANCEL PRINT")}
  G1 E-1 F300
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE


#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
# PAUSE
#éééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééééé
[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
variable_extrude: 1.0 # change this if you need more or less extrusion
gcode:
  {action_respond_info("running : PAUSE")}
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float %}
  #{% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_minimum.y|float %}

  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}

  {% set act_z = printer.toolhead.position.z|float %}
  {% set act_x = printer.toolhead.position.x|float %}
  {% set act_y = printer.toolhead.position.y|float %}


  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F4100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    {action_respond_info("pause to z_safe : %i"% z_safe)}
    G90

    G1 Z+33
    G1 X{x_park} Y{y_park} F6000
    {action_respond_info("pause to x_park : %i"% x_park)}
    {action_respond_info("pause to y_park : %i"% y_park)}
    #G1 Z+33
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %}

#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  {action_respond_info("running : resume")}
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F4100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  RESUME_BASE {get_params}

#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

# Adds print macros such as start print and end print.
# in cura, as start gcode you can define "START_PRINT" and end gcode "END_PRINT"


######################################################################
# Start Print and End Print
######################################################################
# Replace the slicer's custom start and end g-code scripts with
# START_PRINT and END_PRINT.
###############################################################################

[gcode_macro START_PRINT]
gcode:
    #set target temperatures from gcode
    M140 S{printer.heater_bed.target}
    M104 S{printer.extruder.target}

    # Wait for bed to reach temperature
    M190 S{printer.heater_bed.target}
    # Set and wait for nozzle to reach temperature
    M109 S{printer.extruder.target}

    #timeout
    CLEAR_PAUSE                     ; Clears the Pause state
    SET_IDLE_TIMEOUT TIMEOUT=600    ; set the idle timeout (in seconds)

    #preheat bed
    #preheat ext

    # Use absolute coordinates
    G90
    # Reset the G-Code Z offset (adjust Z offset if needed)
    #SET_GCODE_OFFSET Z={Z_OFFSET|float}
    # Home the printer
    G28
    # Use the bed mesh
    BED_MESH_PROFILE LOAD=default
    # Move the nozzle near the bed
    G1 X0 Y10 Z5 F6000

    # Prime line
    PRIME_LINE

###############################################################################

[gcode_macro END_PRINT]
gcode:
    M117 Done printing :)
    # move z up
    G91
    G1 E-3 Z+10 F3000
    # absolute xy
    G90
    G1 X10 Y220 F2000
    #disable hotend and heated bed
    M104 S0
    M140 S0
    # disable steppers
    M84
    BED_MESH_CLEAR

# prime the nozzle
###############################################################################

[gcode_macro PRIME_LINE]
gcode:
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis
    G1 E8 Z2.0 E12 F3000 ;Move Z Axis up

    # move to prime position
    G1 X10 Y10 Z0.25 F5000.0 ;Move to start position
    G4 P15
    G1 E20 F3000
    G1 X02 Y210.0 Z0.28 F500.0 E23 ;Draw the first line
    G1 X07 Y210.0 Z0.27 F500.0 ;Move to side a little
    G1 Y10 Z0.28 F500.0 E17 ;Draw the second line
    G92 E0 ;Reset Extruder
    G1 Z55.0 F300 ;Move Z Axis up

# G29 that does (1) home all (2) get bed mesh (3) move nozzle to corner so it doesnt ooze on the bed while heating up.
###############################################################################


## conditional home
[gcode_macro _CG28]
description: Helper: conditional homing
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}


[gcode_macro G29]
gcode:
    G28
    BED_MESH_CALIBRATE
    G0 X0 Y0 Z10 F6000
    BED_MESH_PROFILE save=default



## conditional home
###############################################################################

[gcode_macro _CG28]
description: Helper: conditional homing
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}
  #{% if "xyz" in printer.toolhead.homed_axes %}

# Park toolhead
###############################################################################

[gcode_macro M125]
gcode:
    SAVE_GCODE_STATE NAME=parking
    M117 Parking toolhead
    G91
    G1 Z20 F600 # move up 5 mm
    G90
    G1 X125 Y0 F4000 # move to park position
    RESTORE_GCODE_STATE NAME=parking
# LOW_TEMP_CHECK
###############################################################################

[gcode_macro LOW_TEMP_CHECK]
gcode:
    # LOW_TEMP_CHECK checks if there is a setpoint for the  extruder. Untested!
    # default_parameter_T: 230 must be set by the new way
    # LOW_TEMP_CHECK checks if there is a setpoint for the  extruder. Untested!
    # - If this setpoint is reached, continue.
    # - If not, heat to setpoint.
    # - If no setpoint, heat to parameter T (default@200)
    {% if printer.extruder.target != 0 %} # if there is a setpoint for extruder
        {% if printer.extruder.temperature < printer.extruder.target %} # if not reached, heat
            M118 Heating from {printer.extruder.temperature} to {printer.extruder.target}.
            M109 S{printer.extruder.target|float}
        {% endif %}
    {% else %} # if no setpoint for extruder
        {% if printer.extruder.target < T %}  # heat to T.
            M118 No setpoint, heating to {T}.
            M109 S{T}
        {% endif %}
    {% endif %}

# load filament
###############################################################################

[gcode_macro M701]
gcode:
    SAVE_GCODE_STATE NAME=loading_filament
    M117 Loading Filament
    M83
    G92 E0.0
    LOW_TEMP_CHECK
    G1 E420 F6000  # length of bowden tube till cold-end (~420mm)
    G1 E100 F200  # some extra to prime the nozzle --> slower
    G92 E0.0
    RESTORE_GCODE_STATE NAME=loading_filament

# unload filament
###############################################################################

[gcode_macro M702]
gcode:
    SAVE_GCODE_STATE NAME=unloading_filament
    M125 # park
    M117 Unloading Filament
    LOW_TEMP_CHECK
    G91 # set relative
    G1 E10 F100
    G92 E0.0
    G1 E-530 F6000 # the E is the length of the bowden tube (420mm) + 100 mm.
    G92 E0.0
    RESTORE_GCODE_STATE NAME=unloading_filament

# filament change
###############################################################################

[gcode_macro M600]
gcode:
    M117 Filament Change
    M118 Filament Change
    SAVE_GCODE_STATE NAME=filament_change
    PAUSE
    LOW_TEMP_CHECK
    G91 # relative
    G1 E-1 F300 # retract 1
    M125 # park
    M702 # unload

    M117 New filament
    M118 New filament
    COUNTDOWN TIME=25 MSG="Switch"
    M701
    COUNTDOWN TIME=10 MSG="Clean"
    RESUME
    M117 Resuming
    M118 Resuming
    RESTORE_GCODE_STATE NAME=filament_change
    M117 Printing..
    M118 Printing..

###############################################################################

[gcode_macro COUNTDOWN]
;default_parameter_MSG: "Time: "
;default_parameter_TIME: 10
gcode:
    # countdown
    {% for s in range(TIME|int, 0, -1) %}
        # dwell 1 second
        G4 P1000
        # echo
        M117 {params.MSG} {s}s
        M118 {params.MSG} {s}s
    {% endfor %}



###############################################################################

[gcode_macro POWER_OFF_PRINTER]
gcode:
  {action_call_remote_method("set_device_power", device="printer", state="off")}
###############################################################################

[gcode_macro POWER_ON_PRINTER]
gcode:
  {action_call_remote_method("set_device_power", device="printer", state="on")}
##############################################################################

[gcode_macro CHECK_PRIME]
gcode:
  {% set bed_temp = params.BED_TEMP|default(50)|int %}
  {% set ext_temp = printer.configfile.settings.extruder.min_extrude_temp|int %}
  {% set bed_temp_act = printer.heater_bed.temperature|int %}
  {% set ext_temp_act = printer.extruder.temperature|int %}

  {% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
    {action_respond_info("This command cannot be used while printing")}
  {% elif printer.extruder.can_extrude|lower == 'false' %}
    {% if bed_temp_act < bed_temp %}
      M140 S{bed_temp}
      {action_respond_info("Bed Temp too low, heat to %iC" % bed_temp)}
    {% endif %}
    {% if ext_temp_act < ext_temp %}}
      M104 S{ext_temp}
      {action_respond_info("Extruder Temp too low, heat to %iC" % ext_temp)}
    {% endif %}
    M109 S{ext_temp}
    M190 S{bed_temp}
    ADV_PRIME_LINE
  {% endif %}


##############################################################################

[gcode_macro ADV_PRIME_LINE]
description: Purge nozzle to left
gcode:
  {action_respond_info("running : prime line")}
  ##### get user defines #####
  {% set start_xy = printer['gcode_macro _USER_VARIABLE'].prime_start_xy %}
  {% set dir = printer['gcode_macro _USER_VARIABLE'].prime_dir|string %}
  {% set lenght = printer['gcode_macro _USER_VARIABLE'].prime_lenght|float %}
  {% set seg = printer['gcode_macro _USER_VARIABLE'].prime_seg|int %}
  {% set extrude_per_seg = printer['gcode_macro _USER_VARIABLE'].prime_extrude_per_seg|float %}
  {% set prime_z = printer['gcode_macro _USER_VARIABLE'].prime_z|float %}
  {% set move_between_lines = printer['gcode_macro _USER_VARIABLE'].prime_dist|float %}
  {% set z_hop = printer['gcode_macro _USER_VARIABLE'].z_hop|float %}
  ##### get parameter and set default #####
  {% set prime_height = params.PRIME_HEIGHT|default(prime_z)|float %}
  ##### get toolhead position #####
  {% set act_z = printer.toolhead.position.z|float %}
  ##### calculate prime line moves #####
  {% set seg_delta = lenght / seg %}
  {% if dir == 'X+' %}
    {% set first_line = 'X%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set second_line = 'X-%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set move_to_side = 'Y%s' % (move_between_lines) %}
  {% elif dir == 'X-' %}
    {% set first_line = 'X-%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set second_line = 'X%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set move_to_side = 'Y%s' % (move_between_lines) %}
  {% elif dir == 'Y+' %}
    {% set first_line = 'Y%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set second_line = 'Y-%s E%s F1500' % (seg_delta, extrude_per_seg) %}
   {% set move_to_side = 'X%s' % (move_between_lines) %}
  {% elif dir == 'Y-' %}
    {% set first_line = 'Y-%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set second_line = 'Y%s E%s F1500' % (seg_delta, extrude_per_seg) %}
    {% set move_to_side = 'X%s' % (move_between_lines) %}
  {% else %}
    {action_raise_error("_USER_VARIABLE.prime_dir is not spezified as X+, X-, Y+ or Y-")}
  {% endif %}
  ##### end of definitions #####

  #-fred _PRINT_AR T="Prime Line" SHOW_LCD=true
  {action_respond_info("homing ")}
  _CG28                                   ; home if not already homed
  G92 E0                                  ; reset Extruder
  G90                                     ; absolute positioning
  {% if act_z < z_hop %}
    G1 Z{z_hop} F900                      ; move head up
  {% endif %}
  G1 X{start_xy[0]} Y{start_xy[1]} F18000 ; move to start position
  G1 Z{prime_height} F900                 ; move Z Axis down
  G91                                     ; relative positioning
  {% for segment in range(seg) %}         ; draw the first line
    G1 {first_line}
  {% endfor %}
  G1 {move_to_side}                       ; move to side
  {% for segment in range(seg) %}         ; draw the second line
    G1 {second_line}
  {% endfor %}
  G1 Z{z_hop} F1500                       ; move Z Axis up
  G92 E0                                  ; reset Extruder
  #UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=1
  {action_respond_info("prime line in progress ")}
# variable_tests: 0
# variable_chamber: 18
# gcode:
#   {% set chamber = params.CHAMBER_TEMP|default(50) %}
#   {% set tests = printer["gcode_macro PRINT_START"].tests|int + 1 %}
#   SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=tests VALUE={tests}
#   SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=chamber VALUE={chamber_temp}
###############################################################################
