[bltouch]
sensor_pin: ^PB1
control_pin: PB0
x_offset: -35
y_offset: -12
#z_offset: 0.375 0217A
#z_offset: check bed mesh sucker
speed: 2.0
sample_retract_dist: 3.5
samples: 5

[safe_z_home]
#home_xy_position: 117.5,117.5 # Change coordinates to the center of your print bed
#home_xy_position: 110,110 # ~fred for nozzle
home_xy_position: 145,122 # ~fred for probe 110+35 & 110+12
z_hop: 3.5                  # 3mm fred
z_hop_speed: 5

[bed_mesh]
speed: 240
horizontal_move_z: 5
mesh_min: 28, 28        #~fred 063-35 & 040 - 12
mesh_max: 200, 200      #~fred 235-35 & 212 - 12
probe_count: 3,3    #~fred
algorithm: bicubic
fade_start: 1
fade_end: 10
fade_target: 0

[screws_tilt_adjust]
screw1: 63,212  #~fred
screw1_name: rear left screw
screw2: 63,40  #~fred
screw2_name: front left screw
screw3: 235,40  #~fred
screw3_name: front right screw
screw4: 235,212 #~fred
screw4_name: rear right screw
horizontal_move_z: 5
speed: 50
screw_thread: CW-M4

[respond]
default_type: command

[pause_resume] recover_velocity: 50

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16          #(200 steps per revolution, 1.8°), run with 1/16 microstepping. So one full rotation is 200 * 16 = 3200 steps
rotation_distance: 40   #The Ender 3 has 20 tooth pulleys so one full rotation of the stepper is 20 * 2 = 40mm
endstop_pin: ^PA5       #3200 steps / 40mm = 80 steps/mm for X and Y
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
#endstop_pin: ^PA7
#position_endstop: 0.0
position_max: 250
position_min: -3
endstop_pin: probe:z_virtual_endstop

[extruder]
max_extrude_only_distance: 100.0
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16            #200 * 16 = 3200 steps
rotation_distance: 31.774 #30.406
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
control: pid
# tuned for stock hardware with 200 degree Celsius target
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
# tuned for stock hardware with 50 degree Celsius target
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[gcode_macro G29]
gcode:
    M117 "HOME AXIS"
    G28

    M117 "BED HEATING"
    M190 S50
    M117 "BED HEATING REACHED"

    M117 "BED CALIBRATE"
    BED_MESH_CALIBRATE

    M117 "BED SAVED AS DEFAULT"
    SAVE_CONFIG
    G0 X0 Y0 Z10
    M117 MACROG29 ENDED
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro CANCEL_PRINT]
description: Cancel the running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    G1 E-5 F300
    M117 "extract for next print"
    TURN_OFF_HEATERS
    M117 "turn off heater"
    CANCEL_PRINT_BASE
    M117 "up to you"
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
variable_extrude: 1.0 # change this if you need more or less extrusion
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F4100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90

    G1 Z+33
    G1 X{x_park} Y{y_park} F6000
    #G1 Z+33
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %}

#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F4100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  RESUME_BASE {get_params}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M117]
description: infos print
rename_existing: M117 { rawparams }
gcode:
  #M117.1 { rawparams }
  #RESPOND PREFIX=“info” MSG="{ params }"
  M118 { rawparams }
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M125]
description: parking hotend # Park toolhead
gcode:
    SAVE_GCODE_STATE NAME=parking
    M117 "Parking toolhead"
    G91         #Use relative position mode
    G1 Z20 F600 # move up 20 mm
    G90         #Use absolute position mode
    G1 X125 Y0 F4000 # move to park position
    RESTORE_GCODE_STATE NAME=parking
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M204]
rename_existing: M204.1
description: VELOCITY
gcode:
  {% set f = params.F|default(0.5)|float %}

  {% if 'S' in params %}
    {% set s = params.S|float %}
    SET_VELOCITY_LIMIT ACCEL={s} ACCEL_TO_DECEL={ s * f }
  {% else %}
    {% if 'P' in params %}
      {% set p = params.P|float %}
      {% if 'T' in params %}
        {% set t = params.T|float %}
        {% if p < t %}
          SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={ p * f }
        {% else %}
          SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={ t * f }
        {% endif %}
      {% else %}
        SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={ p * f }
      {% endif %}
    {% elif 'T' in params %}
      {% set t = params.T|float %}
      SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={ t * f }
    {% endif %}
  {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M205]
description: SQAURE VELOCITY
gcode:
    {% if 'X' in params %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ X }
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

#####################################################################
#  filament related
#####################################################################
[include My_filament.cfg]

#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#'''''''''''''''''''''''''''''''''''''''''''' BLTOUCH MACRO
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro CENTER_Nozzle]
description: Center Nozzle
gcode:
  G91
  G1 Z+5
  G90
  G0 X110 Y110 F2000
  G91
  G1 Z-5
  G90
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro CENTER_Probe]
description: Center Probe
gcode:
  G91
  G1 Z+5
  G90
  G0 X145 Y122 F2000
  G91
  G1 Z-5
  G90

#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
[gcode_macro TEST]
description: Probe TEST
gcode:
 BLTOUCH_DEBUG COMMAND=self_test
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro STOP-TEST]
description: Probe RESET
gcode:
 BLTOUCH_DEBUG COMMAND=reset
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro Z_RESET_OFFSET]
description: Z Adjust NULL
gcode:
 SET_GCODE_OFFSET Z=0.0 MOVE=1

#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\  BED MESH  #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
[gcode_macro A_SCREW_TILT_CALCULATE_HOT_MACRO]
gcode:
  M117 "Homing"
  G28 F5000
  M117 "BED HEATING"
  M190 S50 R55
  M117 "BED HEATING REACHED"
  M117 "TILTING"
  SCREWS_TILT_CALCULATE
  M117 "TILT DONE"
  G1 X0 Y0 Z8 F5000
  M117 "Homing"
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro A_SCREW_TILT_CALCULATE_COLD_MACRO]
gcode:
  M117 "Homing"
  G28 F5000
  M117 "TILTING"
  SCREWS_TILT_CALCULATE
  M117 "TILT DONE"
  G1 X0 Y0 Z8 F5000
  M117 "Homing"
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro B_BED_MESH_CALIBRATE_COLD_MACRO]
gcode:
  M117 "HOME AXIS"
  G28
  M117 "BED_MESH_CALIBRATE"
  BED_MESH_CALIBRATE
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro B_BED_MESH_CALIBRATE_HOT_MACRO]
gcode:
  G29
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro C_PROBE_CALIBRATE_MACRO]
gcode:
  M117 "you can remove PETG residus it's heating"
  M104 S180
  M117 "MAKE SURE BED  SCREW_TILT_CALCULATE_MACRO & BED_MESH_CALIBRATE_COLD_MACRO DONE"
  G28 F6000
  M117 "Grab a piece of paper and slide it between the nozzle and print bed"
  PROBE_CALIBRATE
  M117 "type TESTZ(space)z=-0.1"
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro DE_PROBE_ACCURACY_MACRO]
gcode:
 G28 F5000
 PROBE_ACCURACY
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro E_SAVE_CONFIG_MACRO]
gcode:
 SAVE_CONFIG
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro E_SAVE_MESH_PROFILE_MACRO]
gcode:
 BED_MESH_PROFILE SAVE{S}
 #BED_MESH_PROFILE LOAD=<name> SAVE=<name> REMOVE=<name>
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro LOAD_MESH_DEFAULT_MACRO]
gcode:
 BED_MESH_PROFILE LOAD=default
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro LOADMESH_TONIGHT_MACRO]
gcode:
 BED_MESH_PROFILE LOAD=tonight
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

[gcode_macro LOADMESH_TODAY_MACRO]
gcode:
    BED_MESH_PROFILE LOAD=today
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\


#*# <----------------------                                                                    ---------------------->
[gcode_macro _USER_VARIABLE]
description: Helper: Contains User defined printer variables
##### Homing and general movement #####
#-fred variable_z_endstop: [0,0]             ; z Endstop position
variable_z_endstop_hop: 0             ; z hop for relative moves e.g. homimg
variable_z_hop: 3.5                     ; z_hop depending on mag_probe or endstop
#z_hop: 3.5                  # fred
variable_runout: 'none'               ; none/file/motion/switch depending on cfg
variable_neo_display: 'false'         ; true is display with neopixel in cfg

#### Filament #####
variable_extruder_min_add: 0          ; Temperature add to min Extruder temp
variable_load_distance : 0            ; load distance while load filament
variable_load_extrude : 0             ; extrude distance while load filament
variable_unload_distance : 0          ; unload distance while unload filament
variable_retract_end: 0              ; retract distance at PRINT_END or CANCEL_PRINT
variable_retract_pause: 0             ; retract/extrude distance while PAUSE or RESUME
variable_retract_cancel: 0            ; difference between END and PAUSE retraction
##### Purge & Brush #####
variable_purge: [0,0,0]               ; purge bucket location
variable_wipe_start: [0,0,0]          ; start pos of wipe move
variable_wipe_end: [0,0,0]            ; end pos of wipe move
variable_wipe_offset: 0               ; distance for single wipe move
variable_wipe_cnt: 0                  ; number of full wipes

gcode:
  ###################################################################
  ##                     start of user defines                     ##
  ## this needs to be changed for your printer                     ##
  ###################################################################
  {% set user_z_endstop_hop = 15 %}           ; z hop for moves e.g homimg
  {% set user_extruder_min_add = 30 %}         ; Temperature add to min Extruder temp
  {% set user_load_distance = 70 %}            ; load distance while load filament
  {% set user_load_extrude = 50 %}             ; extrude distance while load filament
  {% set user_unload_distance = 75 %}          ; unload distance while unload filament
  {% set user_retract_end = 2 %}              ; retract distance at PRINT_END or CANCEL_PRINT
  {% set user_retract_pause = 1 %}             ; retract/extrude distance while PAUSE or RESUME

  {% if 'neopixel neo_display' in printer.configfile.settings %}
      SET_GCODE_VARIABLE MACRO=_USER_VARIABLE VARIABLE=neo_display VALUE='"true"'
  {% endif %}

 #{% set user__brush_x_middle: 100 %}         ; mid point of brush at left profile
  {% set user_brush_x_middle = 225 %}          ; mid point of brush at right profil
  {% set user_brush_x_width = 52 %}            ; width of brush
  {% set user_brush_y_start = 301 %}           ; start point at y
  {% set user_wipe_z = 1.5 %}                  ; z for wipe moves
  {% set user_wipe_cnt = 5 %}                  ; number of full wipes
  {% set user_z_purge = 4.5 %}                 ; z above purge bucket
  ##### PRINT_START/STOP #####
  {% set user_print_start_bed_up = 10 %}       ; bed temp raise for faster heat soak
  {% set user_print_start_extruder_time = 3 %} ; time in minutes before soak end to start extruder heating
  {% set user_print_start_bed_time = 3 %}      ; time in minutes before soak end to set bed target temp
  {% set user_print_start_prime_mult = 2 %}    ; multiplier for prime line hight
  {% set user_print_end_unload_sd = 'true' %} ; unload sd file at PRINT_END or CANCEL_PRINT
  ##### Prime Line #####
  {% set user_prime_start_xy = [75.0,5.0] %}   ; x&y start coordinates of prime line
  {% set user_prime_dir = 'X+' %}              ; direction of prime line (X+, X-, Y+, Y-)
  {% set user_prime_z = 0.24 %}                ; z hight for prime line
  {% set user_prime_dist = 0.4 %}              ; distance between line, move will allways positive
  {% set user_prime_lenght = 150 %}            ; length of prime line
  {% set user_prime_seg = 11 %}                ; segments in that the prime line is splitted
  {% set user_prime_extrude_per_seg = 2 %}     ; amount of filament extruded per segment

#*# <----------------------                                                                    ---------------------->


#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.102500, 0.113500, 0.168000
#*# 	0.031500, 0.085500, 0.072000
#*# 	-0.005500, 0.037000, 0.058000
#*# tension = 0.2
#*# min_x = 28.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 2
#*# min_y = 28.0
#*# x_count = 3
#*# max_y = 200.0
#*# mesh_x_pps = 2
#*# max_x = 200.0
#*#
#*# [bed_mesh tonight]
#*# version = 1
#*# points =
#*# 	-0.026000, -0.050000, -0.068500
#*# 	-0.010000, -0.005000, -0.025500
#*# 	0.021000, -0.003000, -0.023500
#*# tension = 0.2
#*# min_x = 28.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 2
#*# min_y = 28.0
#*# x_count = 3
#*# max_y = 200.0
#*# mesh_x_pps = 2
#*# max_x = 200.0
#*#
#*# [bltouch]
#*# z_offset = 0.451
