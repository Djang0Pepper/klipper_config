# [gcode_macro HEAT_BED_SOAK]
# description: heats the bed for a while
# variable_target_temp_bed: 0
# variable_stage_bed: None ## heating -> soaking -> done -> None
# ## in seconds
# variable_check_interval_bed: 10
# variable_soak_time_remaining_bed: 0
# variable_total_time_elapsed_bed: 0

# gcode:
#     {% set TARGET_BED = params.TARGET | default(50) | float %}
#     {% set DURATION_BED = (params.DURATION | default(1) | int) * 60 %} ## minutes to seconds

#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=target_temp_bed         VALUE={ TARGET_BED }
#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=stage_bed               VALUE="'heating'"
#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=soak_time_remaining_bed VALUE={ DURATION_BED }
#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=total_time_elapsed_bed  VALUE=0

#     ;; fire up the heater
#     SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ TARGET_BED }

#     ;; run the fan to circulate air
#     ;;SET_FAN_SPEED PERCENT=50

#     ;; put the bed and nozzle where they're a safe distance apart
#     ;;G28
#     ;CENTER

#     M84 ;; turn off steppers

#     UPDATE_DELAYED_GCODE ID=heat_soaker_bed DURATION={ check_interval_bed }
# #*************************************************************************************

# [gcode_macro CANCEL_HEAT_BED_SOAK]
# description: cancels an in-progress HEAT_BED_SOAK cycle
# gcode:
#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=stage_bed VALUE="'cancel'"
#     UPDATE_DELAYED_GCODE ID=heat_soaker_bed DURATION=1
# #*************************************************************************************

# [delayed_gcode heat_soaker_bed]
# ; ## debug
# ; { action_respond_info( printer['gcode_macro HEAT_BED_SOAK'] | tojson )}
# gcode:
#     {% set heat_soak_bed = printer['gcode_macro HEAT_BED_SOAK'] %}

#     ## update total time elapsed
#     {% set total_time_elapsed_bed = heat_soak_bed.total_time_elapsed_bed + heat_soak_bed.check_interval %}
#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=total_time_elapsed_bed VALUE={ total_time_elapsed_bed }

#     {% set stage_bed = heat_soak_bed.stage_bed%}
#     {% if stage_bed == "heating" and printer.heater_bed.temperature >= heat_soak_bed.target_temp %}
#         {% set stage_bed= "soaking" %}
#     {% endif %}

#     {% if stage_bed== "soaking" %}
#         ## update soak countdown
#         {% set soak_time_remaining_bed = [heat_soak_bed.soak_time_remaining_bed - heat_soak_bed.check_interval, 0] | max %}
#         SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=soak_time_remaining_bed VALUE={ soak_time_remaining_bed }

#         {% if soak_time_remaining_bed == 0 %}
#             {% set stage_bed= "done" %}
#         {% endif %}
#     {% endif %}

#     SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=stage_bed VALUE="'{ stage }'"

#     {% if stage_bedin ("done", "cancel") %}

#         {% if stage_bed== "cancel" %}
#             {% set stage_bed= "done" %}
#             TURN_OFF_HEATERS
#             M107 ; turn off fan

#             M117 { "soak cancelled after ~%.1fm" | format(total_time_elapsed_bed / 60.0) }
#         {% else %}
#             M117 { "soak complete after %.1fm" | format(total_time_elapsed_bed / 60.0) }
#         {% endif %}

#         ## reset all state vars, except stage, which may be queried via the api
#         SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=target_temp         VALUE=0
#         SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=soak_time_remaining_bed VALUE=0
#         SET_GCODE_VARIABLE MACRO=HEAT_BED_SOAK VARIABLE=total_time_elapsed_bed  VALUE=0

#     {% else %}

#         {% if total_time_elapsed_bed % 90 == 0 %}
#             ## output status periodically
#             {% if stage_bed== "heating" %}
#                 M117 { "heating -- %.1fm elapsed" | format(total_time_elapsed_bed / 60.0) }
#             {% elif stage_bed== "soaking" %}
#                 M117 { "soaking -- %.1fm remaining" | format(soak_time_remaining_bed / 60.0) }
#             {% endif %}
#         {% endif %}

#         ## trigger ourselves again
#         UPDATE_DELAYED_GCODE ID=heat_soaker DURATION={ heat_soak_bed.check_interval }

#         ## dwell for 1ms to prevent from going idle
#         G4 P1

#     {% endif %}

# #*************************************************************************************


# [gcode_macro _FREDO_tests]
# gcode:
#   {action_respond_info("running : fredo_test")}
#   {% set park_pos = printer['gcode_macro _USER_VARIABLE'].park_bed %}
# #   {action_respond_info("park pos: %i" % (park_pos[0]))}
# #   {action_respond_info("park pos: %i" % (park_pos[1]))}
# #   {action_respond_info("park pos: %i" % (park_pos[2]))}
# #   {action_respond_info(
# #                         "park pos0: %i" %(park_pos[2]),
# #   #                      "park pos1: %i" %(park_pos[1])
# #   )}

#   #{% set park_bed_array = [calc_center_x|float,calc_center_y|float,user_park_z_min|float] %}
#   #{% set park_pos_array = [(park_pos[0],park_pos[1],park_pos[2]) %}
#   #{action_respond_info("park pos array: %i" % (park_pos_array))}




######################################################################
[gcode_macro fredo_WIPE]
description: Helper: Wipe nozzle at bucket
gcode:
  {action_respond_info("running : fredo_wipe")}
  ##### get user defines #####
  {% set wipe_cnt = printer['gcode_macro _USER_VARIABLE'].wipe_cnt|int %}
  {action_respond_info("wipe count :%i" % (wipe_cnt))}

  {% set wipe_start_pos = printer['gcode_macro _USER_VARIABLE'].wipe_start %}
  {action_respond_info("wipe_start_pos0: %i" % (wipe_start_pos[0]))}
  {action_respond_info("wipe_start_pos1: %i" % (wipe_start_pos[1]))}
  {action_respond_info("wipe_start_pos2: %i" % (wipe_start_pos[2]))}
  {action_respond_info("wipe_end_pos0: %i" % (wipe_end_pos[0]))}

  {% set wipe_end_pos = printer['gcode_macro _USER_VARIABLE'].wipe_end %}
  {action_respond_info("wipe_end: %i" % (wipe_end))}

  {% set wipe_offset = printer['gcode_macro _USER_VARIABLE'].wipe_offset|float %}
  #{action_respond_info("wipe offset :%f" %(wipe_offset))}
  ##### end of definitions #####

  G90 ; absolute positioning

  G0 X{wipe_start_pos[0]} Y{wipe_start_pos[1]} Z{wipe_start_pos[2]} F4000
  #M117 "join XYZ wipe start pos"
  # move head diagonal to brush
  {% for wipe in range(0, wipe_cnt) %}
    {% for coordinate in [wipe_start_pos[0], wipe_end_pos[0]] %}
      G0 X{coordinate} Y{wipe_start_pos[1] + wipe_offset * wipe} F4000
    {% endfor %}
  {% endfor %}
  G0 X{wipe_end_pos[0]} Y{wipe_end_pos[1]} Z{wipe_end_pos[2]} F4000

#####################################################################
##################################################
###################################################### START/END MACROS
#######################################################################

[gcode_macro START_PRINT_SUPERSLICER]
description: a start/end gcode exemple
gcode:
  {action_respond_info("running fredo start print superslicer")}
  G90 ; use absolute coordinates
  M83 ; extruder relative mode

  M140 S{first_layer_bed_temperature[initial_extruder]} ;
  M117 -->set final bed temp

  M104 S150 ;
  M117 -->set temporary nozzle temp to prevent oozing during homing

  G4 S10 ;
  M117 -->allow partial nozzle warmup

  G28 ;
  M117 -->home all axis
  ;G29 ; auto bed levelling

  G1 Z25 F240
  G1 X2 Y10 F3000
  M104 S{first_layer_temperature[initial_extruder]+EXT_TEMPerature_offset[initial_extruder]} ;
  M117 -->set final nozzle temp
  M190 S{first_layer_bed_temperature[initial_extruder]} ;
  M117 -->wait for bed temp to stabilize
  M109 S{first_layer_temperature[initial_extruder]+EXT_TEMPerature_offset[initial_extruder]} ;
  M117 -->wait for nozzle temp to stabilize
  G1 Z0.20 F240 ;Z0.28
  G92 E0

  G1 Y200 E10 F1500 ;
  M117 -->prime the nozzle Y
  G1 X2.3 F1500
  G92 E0
  G1 Y10 E10 F1200 ;
  M117 --> prime the nozzle Y home
  G92 E0

  G1 X200 E10 F1500 ;
  M117 --> prime the nozzle X
  G1 Y10.3 F1500
  G92 E0
  G1 X10 E08 F1200 ;
  M117 --> prime the nozzle X home
  G92 E0


#####################################################################################

[gcode_macro END_PRINT_SUPERSLICER]
description: a start/end gcode exemple
gcode:
  {action_respond_info("running fredo end print superslicer")}
  {%if max_layer_z < max_print_height%}
    G1 Z{z_offset+min(max_layer_z+2, max_print_height)} F600 ; Move print head up
  {%endif%}

  G1 X5 Y{print_bed_max[1]*0.8} F{travel_speed*60} ; present print

  {%if max_layer_z < max_print_height-10%}
    G1 Z{z_offset+min(max_layer_z+70, max_print_height-10)} F600 ; Move print head further up
  {%endif%}

  {%if max_layer_z < max_print_height*0.6%}
    G1 Z{max_print_height*0.6}} F600 ; Move print head further up
  {%endif%}

  M140 S0 ; turn off heatbed
  M104 S0 ; turn off temperature
  M107 ; turn off fan
  M84 X Y E ; disable motors

#####################################################################################

[gcode_macro fredo_START_PRINT]
description: a start/end gcode exemple
gcode:
  {action_respond_info("running fredo start print")}
  #M117 "use gcode_macro inside printer.cfg"
  #https://github.com/Desuuuu/klipper-macros/tree/master/macros
  #useless
  #default_parameter_BED_TEMP: 0
  #default_parameter_EXT_TEMP: S{first_layer_temperature[initial_extruder]+EXT_TEMPerature_offset[initial_extruder]} ;
  #M140 S{first_layer_bed_temperature[initial_extruder]} ;
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXT_TEMP = params.EXT_TEMP|default(180)|float %}

  ;Put printing message on LCD screen
  M117 Heating BED...
  M140 S{BED_TEMP} ; set bed temp
  {% if printer.heater_bed.temperature < params.BED_TEMP|float*0.85 %}
    M190 R{params.BED_TEMP|float*0.85} # wait till 0.85 of bed temp is reached, then continue
  {% endif %}

  G28 X Y; Home X Y
  G1 Y10 F3000; this is a good start heating position
  M190 S{BED_TEMP} ;
  M117 wait for bed temp
  G28 Z ; Home Z
  M104 S{EXT_TEMP} ;
  M117 set extruder temp

  ; Auto Leveling
  BED_MESH_PROFILE LOAD=default
  M117 LOAD DEFAULT MESH
  M109 S{EXT_TEMP} ; wait for extruder temp
  M117 wait for extruder temp
  M117 Priming
  ; Start of print
  G21; metric values
  G90 ; absolute positioning
  M82; set extruder to absolute mode

  G1 Z5; Move nozzle above 5 mm of the bed

  ; now print a line of filament to prepare extrusion
  G92 E0 ; reset extruder
  G1 X5 Y15 F5000.0 ; move to start-line position
  G1 X5 Y15 Z2.3 F5000.0
  ;G1 X5 Y15 Z0.3 F5000.0
  G1 Y20 F1000 E0.8
  G92 E0 ; reset extruder
  G1 X5 Y200.0 Z0.3 F1500.0 E15 ; draw 1st line
  G1 X5.4 Y200.0 Z0.3 F5000.0 ; move to side a little
  G1 X5.4 Y20 Z0.3 F1500.0 E30 ; draw 2nd line
  G1 E34 ; Retract extruder
  G92 E0 ; reset extruder
  G1 Z3.0 F3000 ; move z up little to prevent scratching of surface
  G1 X100 Y100 F15000

  ;Tuning params
  ;Put printing message on LCD screen
  M117 Printing...
  M83
  ; Start of actual GCode for the print

#####################################################################################

[gcode_macro fredo_END_PRINT]
description: a start/end gcode exemple
#https://github.com/Desuuuu/klipper-macros/tree/master/macros
gcode:
  {action_respond_info("running fredo end print")}
    M140 S0
    M104 S0
    G92 E1
    G1 E-1 F300
    M106 S0
    G28 X0
    G90
    M84
    #SAVE_IF_SET
#####################################################################################

[gcode_macro fredo_PRIME_LINE]
description: prime line
gcode:
  {action_respond_info("running fredo prime line")}
  M117 "Prime Line"
  G92 E0 ;Reset Extruder
  M117 "Move z axis"
  G1 Z2.0 F3000 ;Move Z Axis up
  M117 "Move to prime position"
  G1 X20 Y30 Z0.28 F5000.0 ;
  M117 "Move to start position"
  G1 X20 Y200.0 Z0.28 F1500.0 E15 ;
  M117 "Draw the first line"
  G1 X22 Y200.0 Z0.28 F5000.0 ;
  M117 "Move to side a little"
  G1 X22 Y50 Z0.28 F1500.0 E30 ;
  M117 "Draw the second line"
  G92 E0 ;
  M117 "Reset Extruder"
  G1 Z2.0 F3000 ;
  M117 "Move Z Axis up"

#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££
#££££££££££££££££££££££££££££££££££££ SYSTEM MACROS £££££££££££££££££££££££££££££££££
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro G29]
gcode:
    #M117 "running fredo g29"
    {action_respond_info("running fredo g29")}
    G28

    M117 "BED HEATING"
    M190 R50
    M117 "BED HEATING REACHED"

    M117 "BED CALIBRATE"
    BED_MESH_CALIBRATE

    M117 "BED SAVED AS DEFAULT"
    SAVE_CONFIG
    G0 X0 Y0 Z10
    M117 MACROG29 ENDED
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

#[gcode_macro LOW_TEMP_CHECK]
[gcode_macro CHECK_EXT_TEMP]
description: CHECK_EXT_TEMP EXT_T=xxx
gcode:
    {% set EXT_TEMP = params.EXT_T|default(180)|int %}
    {% if printer.extruder.target != 0 %} # if there is a setpoint for extruder
        {% if printer.extruder.temperature < printer.extruder.target %} # if not reached, heat
            M117 Heating from {printer.extruder.temperature} to {printer.extruder.target}.
            M109 S{printer.extruder.target}
            M117 "EXT TEMP Reached"
        {% endif %}
    {% else %} # if no setpoint for extruder
        {% if printer.extruder.target < EXT_TEMP %}  # heat to EXT_T.
            M117 No setpoint, heating to {EXT_TEMP}.
            M109 S{EXT_TEMP}
            M117 "EXT TEMP Reached"
        {% endif %}
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro CHECK_BED_TEMP]
description: CHECK_BED_TEMP BED_T=xxx
gcode:
    {% set BED_TEMP = params.BED_T|default(52)|int %}
    {% if printer.heater_bed.target != 0 %} # if there is a setpoint for heater_bed
        {% if printer.heater_bed.temperature < printer.heater_bed.target %} # if not reached, heat
            M117 Heating from {printer.heater_bed.temperature} to {printer.heater_bed.target}.
            M190 S{printer.heater_bed.target}
            M117 "BED TEMP Reached"
        {% endif %}
    {% else %} # if no setpoint for extruder
        {% if printer.heater_bed.target < BED_TEMP %}  # heat to BED_T.
            M117 No setpoint, heating to {BED_TEMP}.
            M190 S{BED_TEMP}
            M117 "BED TEMP Reached"
        {% endif %}
    {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro COUNTDOWN]
description: ount down msg=coucou time=50(sec)
gcode:
  {% set MSG = params.MSG|default("Time :: ")|string %}
  {% set TIME = params.TIME|default(10)|float %}
  # countdown
  {% for s in range(TIME|int, 0, -1) %}
      # dwell 1 second
      G4 P1000
      # echo
      M117 {params.MSG} {s}s
  {% endfor %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

# [gcode_macro M117]
# rename_existing: M117 { rawparams }
# gcode:
#   #M117.1 { rawparams }
#   #RESPOND PREFIX=“info” MSG="{ params }"
#   M117 { rawparams }
# #££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M204]
rename_existing: M204.1
gcode:
  #{action_respond_info("running fredo m 204")}
  {% set f = params.F|default(0.5)|float %}

  {% if 'S' in params %}
    {% set s = params.S|float %}
    SET_VELOCITY_LIMIT ACCEL={s} ACCEL_TO_DECEL={ s * f }
  {% else %}
    {% if 'P' in params %}
      {% set p = params.P|float %}
      {% if 'T' in params %}
        {% set t = params.T|float %}
        {% if p < t %}
          SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={ p * f }
        {% else %}
          SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={ t * f }
        {% endif %}
      {% else %}
        SET_VELOCITY_LIMIT ACCEL={p} ACCEL_TO_DECEL={ p * f }
      {% endif %}
    {% elif 'T' in params %}
      {% set t = params.T|float %}
      SET_VELOCITY_LIMIT ACCEL={t} ACCEL_TO_DECEL={ t * f }
    {% endif %}
  {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

[gcode_macro M205]
gcode:
  #{action_respond_info("running fredo m 205")}
  {% if 'X' in params %}
      SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ X }
  {% endif %}
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

# Park toolhead
[gcode_macro M125]
description: parking hotend
gcode:
  {action_respond_info("running fredo m 125")}
  SAVE_GCODE_STATE NAME=parking
  M117 "Parking toolhead"
  G91         #Use relative position mode
  G1 Z20 F600 # move up 20 mm
  G90         #Use absolute position mode
  G1 X125 Y0 F4000 # move to park position
  RESTORE_GCODE_STATE NAME=parking
#££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££££

#--------------------------------------------------------------------------------------------------------------------
#-------------------------------------- FILAMENT MACRO -----------------------------------
#------------------------------------------------------------------------------------------

[gcode_macro M701]
description: Load filament LowTempCheck
gcode:
  {action_respond_info("running fredo m701")}
  SAVE_GCODE_STATE NAME=loading_filament
  M117 "Loading Filament"
  M83
  G92 E0.0
  LOW_TEMP_CHECK
  G1 E440 F6000   # length of bowden tube till cold-end (~420mm)
  G1 E100 F200    # some extra to prime the nozzle --> slower
  G92 E0.0
  RESTORE_GCODE_STATE NAME=loading_filament
#------------------------------------------------------------------------------------------

[gcode_macro M702]
description: Unload filament LowTempCheck
gcode:
  {action_respond_info("running fredo m702")}
  SAVE_GCODE_STATE NAME=unloading_filament
  M125 # park
  M117 "Unloading Filament"
  LOW_TEMP_CHECK
  G91 # set relative
  G1 E-10 F100
  G92 E0.0
  G1 E-440 F6000 # the E is the length of the bowden tube (440mm) + 10 mm.
  G92 E0.0
  RESTORE_GCODE_STATE NAME=unloading_filament
#------------------------------------------------------------------------------------------

[gcode_macro FILAMENT_RUNOUT]
description:  Out of filament!
gcode:
  {action_respond_info("running fredo filament runout")}
  #M117 Out of filament!
  SAVE_GCODE_STATE NAME=filament_out
  M117 Pausing...
  PAUSE
  G91 # relative
  G1 E-1 F300 # retract 1
  M117 Unloading...
  M702 # unload
  M117 Setting hotend to 0
  M109 S0
  M117 Replace Filament!
  RESTORE_GCODE_STATE NAME=filament_out
#------------------------------------------------------------------------------------------

[gcode_macro M600]
description: Filament change
gcode:
  {action_respond_info("running fredo m600 change filament")}
  M117 Filament Change
  SAVE_GCODE_STATE NAME=filament_change
  PAUSE
  LOW_TEMP_CHECK
  G91 # relative
  G1 E-1 F300 # retract 1
  M125 # park
  M702 # unload

  M117 New filament
  M117 New filament
  COUNTDOWN TIME=25 MSG="Switch"
  M701
  COUNTDOWN TIME=10 MSG="Clean"
  RESUME
  M117 Resuming

  RESTORE_GCODE_STATE NAME=filament_change
  M117 Printing..

#------------------------------------------------------------------------------------------

[gcode_macro FIL_RETRACT]
description: FIL_RETRACT D=40 F=240
gcode:
  {action_respond_info("running fredo fil retract")}
  {% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int %}
  {% set speed = params.F|default(600)|float %}

  {% if 'D' in params %}
    {% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
      {action_respond_info("This command cannot be used while printing")}
    {% elif printer.extruder.can_extrude|lower == 'false' %}
      {action_respond_info("Extruder Temp too low, heat to %2dC" % minTemp)}
      {% set temp_changed = true %}
      M109 S{minTemp} ; heat extruder and wait
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E-{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% else %}
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E-{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% endif %}
  {% endif %}
#------------------------------------------------------------------------------------------

[gcode_macro FIL_EXTRACT]
description: FIL_EXTRACT D=40 F=240
gcode:
  {action_respond_info("running fredo fil extract")}
  {% set speed = params.F|default(600)|float %}
  {% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int %}
  #{% set add_temp = printer['gcode_macro _USER_VARIABLE'].extruder_min_add|int %}
  #{% set minTemp = printer.configfile.settings.extruder.min_extrude_temp|int + add_temp %}
  {% if 'D' in params %}
    {% if printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
      {action_respond_info("This command cannot be used while printing")}
    {% elif printer.extruder.can_extrude|lower == 'false' %}
      {action_respond_info("Extruder Temp too low, heat to %2dC" % minTemp)}
      {% set temp_changed = true %}
      M109 S{minTemp} ; heat extruder and wait
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E-{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% else %}
      SAVE_GCODE_STATE NAME=RETRACT_state
      M83
      G1 E{params.D} F{speed}
      M117  "G1 E{params.D} F{speed}"
      RESTORE_GCODE_STATE NAME=RETRACT_state MOVE=0
    {% endif %}
  {% endif %}
#------------------------------------------------------------------------------------------

[gcode_macro BUG_FILAMENT_LOAD]
description: buggé
#variable_parameter_T_BED: 60
#variable_parameter_T_EXTRUDER: 190
gcode:
  {action_respond_info("running fredo bug filament load")}
  {% set BED_TEMP = params.BED_TEMP|default(060)|float %}
  {% if printer.heater_bed.temperature < params.BED_TEMP|float*0.85 %}
    M190 S{params.BED_TEMP|float*0.85} # wait till 0.85 of bed temp is reached, then continue
  {% endif %}
  M83           ; set e to relative positioning
  G92 E0.0
  G1 E100 F1000  ; Initially go fast

  G92 E0.0
  G1 E100 F1000  ; Initially go fast

  G92 E0.0
  G1 E100 F1000  ; Initially go fast

  G92 E0.0
  G1 E100 F1000  ; Initially go fast

  G92 E0.0
  G1 E40 F200  ; then go slow

  G92 E0.0




#------------------------------------------------------------------------------------------

[gcode_macro BUG_FILAMENT_UNLOAD]
description: buggé
gcode:
   {action_respond_info("running fredo bug filament unload")}
    M83           ; set e to relative positioning
    # wiggle filament out of the nozzle
    G1 E0.5 F1000
    G1 E-0.5 F1000
    G1 E1.0 F1000
    G1 E-1.0 F1000
    G1 E1.5 F1000
    G1 E-1.5 F1000
    G1 E2.0 F1000

    G1 E-440 F3000 ;fully unload
    G92 E0.0

  # M600: Filament Change. This macro will pause the printer, move the
  # tool to the change position, and retract the filament 50mm. Adjust
  # the retraction settings for your own extruder. After filament has
  # been changed, the print can be resumed from its previous position
  # with the "RESUME" gcode.
#------------------------------------------------------------------------------------------

[gcode_macro PULL_COLD]
description: Cancel the print and made a pull cold
gcode:
  {action_respond_info("running fredo pull cold")}
  M140 S0        ;
  M117 "turn off heatbed"
  M104 S0        ;
  M117 "turn off temperature"
  #M84 X Y  E      ; disable motors
  G0 Y50 X220 Z+25 F6000 ;
  M117 "prepare cooling"
  M106 S255   ;
  M117 "set the fan to full speed"
  M109 R185 ;
  M117 "wait extruder cooling for reaching 180 "
  M106 S0   ;
  M117 "set the fan to disable"
  G0 Y220 X220 F6000 ;

  M107 ;
  M117 "turn off fan"
  M83
  G1 E-5 F300
  M117 "extract for next print"
  TURN_OFF_HEATERS
  M117 "turn off heater"
  M84
  M117 "motors OFF take your piece"
  CANCEL_PRINT_BASE


#------------------------------------------------------------------------------------------


#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#'''''''''''''''''''''''''''''''''''''''''''' BLTOUCH MACRO
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro CENTER_Nozzle]
description: Center Nozzle
gcode:
  G91
  G1 Z+5
  G90
  G0 X110 Y110 F2000
  G91
  G1 Z-5
  G90
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro CENTER_Probe]
description: Center Probe
gcode:
  G91
  G1 Z+5
  G90
  G0 X145 Y122 F2000
  G91
  G1 Z-5
  G90

#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro PROBING]
description: Bltouch PROBE
gcode:
 probe
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro UP]
description: Pin UP
gcode:
 BLTOUCH_DEBUG COMMAND=pin_up
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro DOWN]
description: Pin DOWN
gcode:
 BLTOUCH_DEBUG COMMAND=pin_down
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro TEST]
description: Probe TEST
gcode:
 BLTOUCH_DEBUG COMMAND=self_test
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro STOP-TEST]
description: Probe RESET
gcode:
 BLTOUCH_DEBUG COMMAND=reset
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro Z_RESET_OFFSET]
description: Z Adjust NULL
gcode:
 SET_GCODE_OFFSET Z=0.0 MOVE=1
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

[gcode_macro GET_POS]
description: GET_POSITION
gcode:
 GET_POSITION
#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
#\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\  BED MESH  #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
# [gcode_macro A_SCREW_TILT_CALCULATE_HOT_MACRO]
# gcode:
#   M117 "Homing"
#   G28 F5000
#   M117 "BED HEATING"
#   M190 S50 R55
#   M117 "BED HEATING REACHED"
#   M117 "TILTING"
#   SCREWS_TILT_CALCULATE
#   M117 "TILT DONE"
#   G1 X0 Y0 Z8 F5000
#   M117 "Homing"
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro A_SCREW_TILT_CALCULATE_COLD_MACRO]
# gcode:
#   M117 "Homing"
#   G28 F5000
#   M117 "TILTING"
#   SCREWS_TILT_CALCULATE
#   M117 "TILT DONE"
#   G1 X0 Y0 Z8 F5000
#   M117 "Homing"
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro B_BED_MESH_CALIBRATE_COLD_MACRO]
# gcode:
#   M117 "HOME AXIS"
#   G28
#   M117 "BED_MESH_CALIBRATE"
#   BED_MESH_CALIBRATE
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro B_BED_MESH_CALIBRATE_HOT_MACRO]
# gcode:
#   G29
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro C_PROBE_CALIBRATE_MACRO]
# gcode:
#   M117 "you can remove PETG residus it's heating"
#   M104 S180
#   M117 "MAKE SURE BED  SCREW_TILT_CALCULATE_MACRO & BED_MESH_CALIBRATE_COLD_MACRO DONE"
#   G28 F6000
#   M117 "Grab a piece of paper and slide it between the nozzle and print bed"
#   PROBE_CALIBRATE
#   M117 "type TESTZ(space)z=-0.1"
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro DE_PROBE_ACCURACY_MACRO]
# gcode:
#  G28 F5000
#  PROBE_ACCURACY
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro E_SAVE_CONFIG_MACRO]
# gcode:
#  SAVE_CONFIG
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro E_SAVE_MESH_PROFILE_MACRO]
# gcode:
#  BED_MESH_PROFILE SAVE{S}
#  #BED_MESH_PROFILE LOAD=<name> SAVE=<name> REMOVE=<name>
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro LOAD_MESH_DEFAULT_MACRO]
# gcode:
#  BED_MESH_PROFILE LOAD=default
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro LOADMESH_TONIGHT_MACRO]
# gcode:
#  BED_MESH_PROFILE LOAD=tonight
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\

# [gcode_macro LOADMESH_TODAY_MACRO]
# gcode:
#  BED_MESH_PROFILE LOAD=today
# #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\ \\\\\\\\\\\\\\\\\\\\\\\
